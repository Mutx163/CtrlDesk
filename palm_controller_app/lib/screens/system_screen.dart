import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';
import '../providers/connection_provider.dart';
import '../models/control_message.dart';
import '../services/socket_service.dart';

class SystemScreen extends ConsumerWidget {
  const SystemScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final connectionStatus = ref.watch(connectionStatusProvider);
    
    return Scaffold(
      appBar: AppBar(
        title: const Text('Á≥ªÁªüÊéßÂà∂'),
        leading: IconButton(
          icon: const Icon(Icons.arrow_back),
          onPressed: () => context.pop(),
        ),
      ),
      body: connectionStatus == ConnectionStatus.connected
          ? _buildSystemControlView(context, ref)
          : _buildNotConnectedView(context),
    );
  }

  Widget _buildSystemControlView(BuildContext context, WidgetRef ref) {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.stretch,
        children: [
          // ÁîµÊ∫êÁÆ°ÁêÜÈÉ®ÂàÜ
          _buildSectionCard(
            context: context,
            title: 'ÁîµÊ∫êÁÆ°ÁêÜ',
            icon: Icons.power_settings_new,
            iconColor: Colors.red,
            children: [
              _buildSystemButton(
                context: context,
                ref: ref,
                title: 'ÈîÅÂÆöÂ±èÂπï',
                subtitle: 'ÈîÅÂÆöPCÂ±èÂπï',
                icon: Icons.lock,
                iconColor: Colors.orange,
                action: 'lock',
                requireConfirm: false,
              ),
              const SizedBox(height: 12),
              _buildSystemButton(
                context: context,
                ref: ref,
                title: 'Áù°Áú†',
                subtitle: 'ËÆ©PCËøõÂÖ•Áù°Áú†Áä∂ÊÄ?,
                icon: Icons.bedtime,
                iconColor: Colors.blue,
                action: 'sleep',
                requireConfirm: true,
                confirmTitle: 'Á°ÆËÆ§Áù°Áú†',
                confirmMessage: 'Á°ÆÂÆöË¶ÅËÆ©PCËøõÂÖ•Áù°Áú†Áä∂ÊÄÅÂêóÔº?,
              ),
              const SizedBox(height: 12),
              _buildSystemButton(
                context: context,
                ref: ref,
                title: 'ÈáçÂêØ',
                subtitle: 'ÈáçÂêØPCÁ≥ªÁªü',
                icon: Icons.restart_alt,
                iconColor: Colors.orange,
                action: 'restart',
                requireConfirm: true,
                confirmTitle: 'Á°ÆËÆ§ÈáçÂêØ',
                confirmMessage: 'Á°ÆÂÆöË¶ÅÈáçÂêØPCÂêóÔºüËØ∑Á°Æ‰øùÂ∑≤‰øùÂ≠òÊâÄÊúâÂ∑•‰Ωú„Ä?,
              ),
              const SizedBox(height: 12),
              _buildSystemButton(
                context: context,
                ref: ref,
                title: 'ÂÖ≥Êú∫',
                subtitle: 'ÂÖ≥Èó≠PCÁîµÊ∫ê',
                icon: Icons.power_off,
                iconColor: Colors.red,
                action: 'shutdown',
                requireConfirm: true,
                confirmTitle: 'Á°ÆËÆ§ÂÖ≥Êú∫',
                confirmMessage: 'Á°ÆÂÆöË¶ÅÂÖ≥Èó≠PCÂêóÔºüËØ∑Á°Æ‰øùÂ∑≤‰øùÂ≠òÊâÄÊúâÂ∑•‰Ωú„Ä?,
              ),
            ],
          ),
          
          const SizedBox(height: 20),
          
          // ÊºîÁ§∫ÊéßÂà∂ÈÉ®ÂàÜ
          _buildSectionCard(
            context: context,
            title: 'ÊºîÁ§∫ÊéßÂà∂',
            icon: Icons.slideshow,
            iconColor: Colors.green,
            children: [
              Row(
                children: [
                  Expanded(
                    child: _buildSystemButton(
                      context: context,
                      ref: ref,
                      title: '‰∏ä‰∏ÄÈ°?,
                      subtitle: 'PPT‰∏ä‰∏ÄÈ°?,
                      icon: Icons.navigate_before,
                      iconColor: Colors.blue,
                      action: 'ppt_previous',
                      requireConfirm: false,
                      isCompact: true,
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: _buildSystemButton(
                      context: context,
                      ref: ref,
                      title: '‰∏ã‰∏ÄÈ°?,
                      subtitle: 'PPT‰∏ã‰∏ÄÈ°?,
                      icon: Icons.navigate_next,
                      iconColor: Colors.blue,
                      action: 'ppt_next',
                      requireConfirm: false,
                      isCompact: true,
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 12),
              _buildSystemButton(
                context: context,
                ref: ref,
                title: 'ÂºÄÂßãÊîæÊò?,
                subtitle: 'ÊåâF5ÂºÄÂßãÂπªÁÅØÁâáÊîæÊò†',
                icon: Icons.play_arrow,
                iconColor: Colors.green,
                action: 'presentation_start',
                requireConfirm: false,
              ),
              const SizedBox(height: 12),
              _buildSystemButton(
                context: context,
                ref: ref,
                title: 'ÈÄÄÂá∫ÊîæÊò?,
                subtitle: 'ÊåâEscÈÄÄÂá∫ÂπªÁÅØÁâáÊîæÊò†',
                icon: Icons.stop,
                iconColor: Colors.red,
                action: 'presentation_end',
                requireConfirm: false,
              ),
            ],
          ),
          
          const SizedBox(height: 20),
          
          // Á≥ªÁªü‰ø°ÊÅØÈÉ®ÂàÜ
          _buildSectionCard(
            context: context,
            title: 'Á≥ªÁªü‰ø°ÊÅØ',
            icon: Icons.info,
            iconColor: Colors.purple,
            children: [
              _buildInfoTile(
                title: 'ËøûÊé•Áä∂ÊÄ?,
                value: 'Â∑≤ËøûÊé?,
                icon: Icons.wifi,
                valueColor: Colors.green,
              ),
              const SizedBox(height: 8),
                             _buildInfoTile(
                 title: 'PCÂú∞ÂùÄ',
                 value: ref.watch(currentConnectionProvider)?.ipAddress ?? 'Êú™Áü•',
                 icon: Icons.computer,
               ),
               const SizedBox(height: 8),
               _buildInfoTile(
                 title: 'ËøûÊé•Á´ØÂè£',
                 value: '${ref.watch(currentConnectionProvider)?.port ?? 'Êú™Áü•'}',
                 icon: Icons.settings_ethernet,
               ),
            ],
          ),
          
          const SizedBox(height: 20),
        ],
      ),
    );
  }

  Widget _buildNotConnectedView(BuildContext context) {
    return Center(
      child: Padding(
        padding: const EdgeInsets.all(32),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(
              Icons.wifi_off,
              size: 80,
              color: Colors.grey,
            ),
            const SizedBox(height: 24),
            Text(
              'Êú™ËøûÊé?,
              style: Theme.of(context).textTheme.headlineSmall,
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 12),
            Text(
              'ËØ∑ÂÖàËøûÊé•Âà∞PCÁ´ØÊâçËÉΩ‰ΩøÁî®Á≥ªÁªüÊéßÂà∂ÂäüËÉ?,
              style: TextStyle(
                color: Colors.grey[600],
                fontSize: 16,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 32),
            FilledButton.icon(
              onPressed: () => context.push('/connect'),
              icon: const Icon(Icons.settings),
              label: const Text('ÁÆ°ÁêÜËøûÊé•'),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildSectionCard({
    required BuildContext context,
    required String title,
    required IconData icon,
    required Color iconColor,
    required List<Widget> children,
  }) {
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(icon, color: iconColor, size: 24),
                const SizedBox(width: 12),
                Text(
                  title,
                  style: Theme.of(context).textTheme.titleMedium?.copyWith(
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ],
            ),
            const SizedBox(height: 16),
            ...children,
          ],
        ),
      ),
    );
  }

  Widget _buildSystemButton({
    required BuildContext context,
    required WidgetRef ref,
    required String title,
    required String subtitle,
    required IconData icon,
    required Color iconColor,
    required String action,
    required bool requireConfirm,
    String? confirmTitle,
    String? confirmMessage,
    bool isCompact = false,
  }) {
    return Card(
      child: InkWell(
        onTap: () => _handleSystemAction(
          context: context,
          ref: ref,
          action: action,
          requireConfirm: requireConfirm,
          confirmTitle: confirmTitle,
          confirmMessage: confirmMessage,
        ),
        borderRadius: BorderRadius.circular(12),
        child: Container(
          padding: EdgeInsets.all(isCompact ? 12 : 16),
          child: Row(
            children: [
              Icon(icon, color: iconColor, size: isCompact ? 20 : 24),
              const SizedBox(width: 12),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      title,
                      style: Theme.of(context).textTheme.bodyLarge?.copyWith(
                        fontWeight: FontWeight.w500,
                      ),
                    ),
                    if (!isCompact) ...[
                      const SizedBox(height: 4),
                      Text(
                        subtitle,
                        style: Theme.of(context).textTheme.bodySmall?.copyWith(
                          color: Colors.grey[600],
                        ),
                      ),
                    ],
                  ],
                ),
              ),
              Icon(
                Icons.chevron_right,
                color: Colors.grey[400],
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildInfoTile({
    required String title,
    required String value,
    required IconData icon,
    Color? valueColor,
  }) {
    return Row(
      children: [
        Icon(icon, size: 20, color: Colors.grey[600]),
        const SizedBox(width: 12),
        Expanded(
          child: Text(
            title,
            style: const TextStyle(fontWeight: FontWeight.w500),
          ),
        ),
        Text(
          value,
          style: TextStyle(
            color: valueColor ?? Colors.grey[600],
            fontWeight: FontWeight.w500,
          ),
        ),
      ],
    );
  }

  Future<void> _handleSystemAction({
    required BuildContext context,
    required WidgetRef ref,
    required String action,
    required bool requireConfirm,
    String? confirmTitle,
    String? confirmMessage,
  }) async {
    // Â¶ÇÊûúÈúÄË¶ÅÁ°ÆËÆ§ÔºåÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°?    if (requireConfirm) {
      final confirmed = await _showConfirmDialog(
        context: context,
        title: confirmTitle ?? 'Á°ÆËÆ§Êìç‰Ωú',
        message: confirmMessage ?? 'Á°ÆÂÆöË¶ÅÊâßË°åÊ≠§Êìç‰ΩúÂêóÔºü',
      );
      
      if (!confirmed) return;
    }

    // ÊâßË°åÁ≥ªÁªüÊéßÂà∂Êìç‰Ωú
    await _sendSystemCommand(ref, action);
    
    // Ëß¶ËßâÂèçÈ¶à
    HapticFeedback.lightImpact();
    
    // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
    if (context.mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(_getActionSuccessMessage(action)),
          duration: const Duration(seconds: 2),
        ),
      );
    }
  }

  Future<bool> _showConfirmDialog({
    required BuildContext context,
    required String title,
    required String message,
  }) async {
    final result = await showDialog<bool>(
      context: context,
      builder: (context) => AlertDialog(
        title: Row(
          children: [
            const Icon(Icons.warning, color: Colors.orange),
            const SizedBox(width: 12),
            Text(title),
          ],
        ),
        content: Text(message),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(false),
            child: const Text('ÂèñÊ∂à'),
          ),
          FilledButton(
            onPressed: () => Navigator.of(context).pop(true),
            style: FilledButton.styleFrom(
              backgroundColor: Colors.orange,
            ),
            child: const Text('Á°ÆËÆ§'),
          ),
        ],
      ),
    );
    
    return result ?? false;
  }

  Future<void> _sendSystemCommand(WidgetRef ref, String action) async {
    final socketService = ref.read(socketServiceProvider);
    final messageId = DateTime.now().millisecondsSinceEpoch.toString();
    
    final message = ControlMessage.systemControl(
      messageId: messageId,
      action: action,
    );
    
    await socketService.sendMessage(message);
  }

  String _getActionSuccessMessage(String action) {
    switch (action) {
      case 'lock':
        return 'Â∑≤ÂèëÈÄÅÈîÅÂÆöÂ±èÂπïÊåá‰ª?;
      case 'sleep':
        return 'Â∑≤ÂèëÈÄÅÁù°Áú†Êåá‰ª?;
      case 'restart':
        return 'Â∑≤ÂèëÈÄÅÈáçÂêØÊåá‰ª?;
      case 'shutdown':
        return 'Â∑≤ÂèëÈÄÅÂÖ≥Êú∫Êåá‰ª?;
      case 'ppt_next':
        return 'Â∑≤ÂàáÊç¢Âà∞‰∏ã‰∏ÄÈ°?;
      case 'ppt_previous':
        return 'Â∑≤ÂàáÊç¢Âà∞‰∏ä‰∏ÄÈ°?;
      case 'presentation_start':
        return 'Â∑≤ÂèëÈÄÅÂºÄÂßãÊîæÊò†Êåá‰ª?;
      case 'presentation_end':
        return 'Â∑≤ÂèëÈÄÅÈÄÄÂá∫ÊîæÊò†Êåá‰ª?;
      default:
        return 'Êåá‰ª§Â∑≤ÂèëÈÄ?;
    }
  }
} 
